# –õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ 1.4: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ target_taxa –∏–∑ taxid

**–î–∞—Ç–∞**: 23 –æ–∫—Ç—è–±—Ä—è 2025  
**–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞**: 14:56  
**–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è**: 15:00  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

## –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

–°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å/—Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è `target_taxa` –∏–∑ `taxid` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º NCBI rankedlineage.dmp —Ñ–∞–π–ª–∞.

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- **–í—Ö–æ–¥**: taxid (–∏–∑ meta), ncbi_ranked_lineage_path, taxonomy_level (–ø–∞—Ä–∞–º–µ—Ç—Ä)
- **–í—ã—Ö–æ–¥**: target_taxa —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `level:taxa_name` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `order:Artiodactyla`)
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: Warning + skip Sourmash –µ—Å–ª–∏ taxid –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É—Ä–æ–≤–µ–Ω—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏

### 1. –ò–∑—É—á–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ NCBI ranked lineage —Ñ–∞–π–ª–∞ ‚úÖ

**–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**:
- `/Users/dz11/github/ascc/bin/parse_fcsgx_result.py` (—Ñ—É–Ω–∫—Ü–∏—è `get_lineages_by_taxid`)
- `/Users/dz11/github/ascc/bin/get_lineage_for_top.py` (—Ñ—É–Ω–∫—Ü–∏—è `parse_taxdump`)

**–§–æ—Ä–º–∞—Ç rankedlineage.dmp**:
```
taxid | name | species | genus | family | order | class | phylum | kingdom | domain
```
- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: `|`
- –ò–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫:
  - 0: taxid
  - 1: name
  - 2: species
  - 3: genus
  - 4: family
  - 5: order
  - 6: class
  - 7: phylum
  - 8: kingdom
  - 9: domain

### 2. –°–æ–∑–¥–∞–Ω–∏–µ Python —Å–∫—Ä–∏–ø—Ç–∞ ‚úÖ

**–§–∞–π–ª**: `/Users/dz11/github/ascc/bin/get_target_taxa_from_taxid.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
- –ü–∞—Ä—Å–∏–Ω–≥ rankedlineage.dmp —Ñ–∞–π–ª–∞
- –ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–∏ –ø–æ taxid
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–∫—Å–æ–Ω–∞ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º —É—Ä–æ–≤–Ω–µ (species, genus, family, order, class, phylum, kingdom, domain)
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫—É `level:taxa_name`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
  - –ï—Å–ª–∏ taxid –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç "TAXID_NOT_FOUND" –≤ –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª + warning –≤ stderr
  - –ï—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –ø—É—Å—Ç–æ–π ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç "LEVEL_EMPTY" –≤ –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª + warning –≤ stderr
  - –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å exit code 0 (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç pipeline)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏**:
```bash
--taxid <taxid>              # Target taxid –¥–ª—è –ø–æ–∏—Å–∫–∞
--rankedlineage <path>       # –ü—É—Ç—å –∫ NCBI rankedlineage.dmp
--level <level>              # –£—Ä–æ–≤–µ–Ω—å —Ç–∞–∫—Å–æ–Ω–æ–º–∏–∏ (order, class, family, etc.)
--output <output_file>       # –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –¥–ª—è target_taxa
--version                    # –í–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞
```

**–í–µ—Ä—Å–∏—è**: 1.0.0

### 3. –°–æ–∑–¥–∞–Ω–∏–µ Nextflow –º–æ–¥—É–ª—è ‚úÖ

**–§–∞–π–ª**: `/Users/dz11/github/ascc/modules/local/get/target_taxa/main.nf`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞**:
```groovy
process GET_TARGET_TAXA {
    tag "${meta.id}"
    label 'process_low'
    
    input:
    tuple val(meta), val(taxid)
    path( rankedlineage )
    val( taxonomy_level )
    
    output:
    tuple val(meta), path( "*.txt" ) , emit: target_taxa
    path "versions.yml"              , emit: versions
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Python 3.9 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä/conda environment
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ (grep –¥–ª—è TAXID_NOT_FOUND –∏–ª–∏ LEVEL_EMPTY)
- –í—ã–≤–æ–¥–∏—Ç warning –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç pipeline
- –í–∫–ª—é—á–∞–µ—Ç stub-–≤–µ—Ä—Å–∏—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç versions.yml —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–µ—Ä—Å–∏—è—Ö

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã**:
- `/Users/dz11/github/ascc/modules/local/get/target_taxa/environment.yml` - conda –æ–∫—Ä—É–∂–µ–Ω–∏–µ (Python 3.9)

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ‚úÖ

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã**:

1. **–í Python —Å–∫—Ä–∏–ø—Ç–µ**:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è rankedlineage.dmp —Ñ–∞–π–ª–∞
   - –ü–æ–∏—Å–∫ taxid –≤ —Ñ–∞–π–ª–µ
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–º —É—Ä–æ–≤–Ω–µ —Ç–∞–∫—Å–æ–Ω–æ–º–∏–∏
   - –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ stderr
   - –ó–∞–ø–∏—Å—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ –≤ –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

2. **–í Nextflow –º–æ–¥—É–ª–µ**:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –æ—à–∏–±–æ–∫
   - –í—ã–≤–æ–¥ warning –≤ stderr –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫
   - –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã pipeline (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)

**–ú–µ—Ö–∞–Ω–∏–∑–º skip Sourmash**:
- –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ä–∫–µ—Ä –æ—à–∏–±–∫–∏ (TAXID_NOT_FOUND –∏–ª–∏ LEVEL_EMPTY)
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –º–æ–≥—É—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∏ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
- –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ workflow –ø—Ä–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è

## –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **Python —Å–∫—Ä–∏–ø—Ç**:
   - `/Users/dz11/github/ascc/bin/get_target_taxa_from_taxid.py` (–∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π)

2. **Nextflow –º–æ–¥—É–ª—å**:
   - `/Users/dz11/github/ascc/modules/local/get/target_taxa/main.nf`
   - `/Users/dz11/github/ascc/modules/local/get/target_taxa/environment.yml`

3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
   - `/Users/dz11/github/copilot_playground/ascc/task_1.4_log_2025-10-23_15-00.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### Python —Å–∫—Ä–∏–ø—Ç:
```bash
get_target_taxa_from_taxid.py \
    --taxid 9913 \
    --rankedlineage /path/to/rankedlineage.dmp \
    --level order \
    --output target_taxa.txt
```

**–í—ã—Ö–æ–¥** (—É—Å–ø–µ—à–Ω—ã–π):
```
order:Artiodactyla
```

**–í—ã—Ö–æ–¥** (–æ—à–∏–±–∫–∞ - taxid –Ω–µ –Ω–∞–π–¥–µ–Ω):
```
TAXID_NOT_FOUND
```

### Nextflow –º–æ–¥—É–ª—å:
```groovy
GET_TARGET_TAXA (
    sample_with_taxid,           // tuple val(meta), val(taxid)
    ncbi_ranked_lineage_path,    // path
    params.sourmash_taxonomy_level  // val
)
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ó–∞–¥–∞—á–∞ 1.4 –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
2. ‚è≠Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ (–§–∞–∑–∞ 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è RUN_SOURMASH)
3. üìù –ú–æ–¥—É–ª—å –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ workflow –ø—Ä–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Sourmash

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **Label**: `process_low` (–Ω–∏–∑–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ—Å—É—Ä—Å–∞–º)
- **–û–±—Ä–∞–±–æ—Ç–∫–∞**: –û–¥–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–µ —á—Ç–µ–Ω–∏–µ rankedlineage.dmp (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –ø–∞–º—è—Ç—å)
- **–°–∫–æ—Ä–æ—Å—Ç—å**: –ë—ã—Å—Ç—Ä–∞—è (–ø–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ taxid)

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
- Python 3.9+
- Nextflow DSL2
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å conda –∏ singularity/docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏

### –í–∞–ª–∏–¥–∞—Ü–∏—è:
- –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- Nextflow –º–æ–¥—É–ª—å –≤–∫–ª—é—á–∞–µ—Ç stub –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ì–æ—Ç–æ–≤ –∫ –Ω–∞–ø–∏—Å–∞–Ω–∏—é nf-test —Ç–µ—Å—Ç–æ–≤ (–±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–∑–∂–µ –≤ –∑–∞–¥–∞—á–µ 2.5)

## –ó–∞–º–µ—Ç–∫–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

–ü—Ä–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ workflow (`ascc_genomic.nf`):

1. –í—ã–∑–≤–∞—Ç—å –º–æ–¥—É–ª—å –ø–µ—Ä–µ–¥ RUN_SOURMASH:
```groovy
GET_TARGET_TAXA (
    ch_samples_with_taxid,
    ncbi_ranked_lineage_path,
    params.sourmash_taxonomy_level
)
```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å failed samples:
```groovy
ch_valid_target_taxa = GET_TARGET_TAXA.out.target_taxa
    .map { meta, file ->
        def content = file.text.trim()
        if (content == "TAXID_NOT_FOUND" || content == "LEVEL_EMPTY") {
            log.warn "Skipping Sourmash for sample ${meta.id}: ${content}"
            return null
        }
        return [meta, content]
    }
    .filter { it != null }
```

3. –ü–µ—Ä–µ–¥–∞—Ç—å –≤ RUN_SOURMASH —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –æ–±—Ä–∞–∑—Ü—ã

---

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~4 –º–∏–Ω—É—Ç—ã  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
